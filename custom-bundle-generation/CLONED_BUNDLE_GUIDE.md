# Creating Custom ACM Bundle from Cloned acm-operator-bundle Repository

This guide details the complete workflow for creating and testing custom ACM operator bundles, from code changes to deployed operator.

Generated by CLAUDE AI, and edited for correctness and consistency by Nathaniel Graham (ngraham@redhat.com)

## Prerequisites

- Access to container registry (e.g., quay.io)  
- Multiclusterhub-operator repository cloned locally
- Pull secret configured for your registry
  - **Important**: Since the bundle we're pulling is the Konflux one, it will need access to quay.io/acm-d for some resources. As such, you will need to get your pull-secret onto the cluster
- OpenShift cluster with OLM

# Make Code Changes and Build Operator

### Make Your Changes
```bash
cd /path/to/multiclusterhub-operator
# Make your code changes (controllers, API types, etc.)
```

### Update CRDs if Needed
If you added new fields to CRD types, generate updated CRDs:
```bash
make manifests
```

### Build and Push Operator Image
```bash
# Use incremental tags: v1, v2, v3, etc.
IMG=quay.io/YOUR_USERNAME/multiclusterhub-operator:2.15.0-custom-v1 make podman-build
podman push quay.io/YOUR_USERNAME/multiclusterhub-operator:2.15.0-custom-v1
```

# Clone and Prepare the Custom Bundle

```bash
git clone https://github.com/stolostron/acm-operator-bundle.git
cd acm-operator-bundle
```

### Copy Updated CRDs (If You Made API Changes)
If you generated new CRDs in Step 1, copy them to the bundle:
**Important** The bundle will now be deploying your generated CSV.

```bash
# Copy updated CRDs from your operator repo
cp /path/to/multiclusterhub-operator/config/crd/bases/*.yaml manifests/
```

## Identify What's Already Configured

The cloned repository comes pre-configured with:
- ✅ Complete bundle structure (`manifests/`, `metadata/`, `extras/`)
- ✅ Proper `metadata/annotations.yaml` with correct bundle metadata
- ✅ All CRD files in `manifests/` directory
- ✅ Complete ClusterServiceVersion (CSV) template
- ✅ Dockerfile for building bundle image

## Required Changes to CSV

**CRITICAL**: These changes must exactly match your operator image from Step 1:

### Find the CSV file in the cloned bundle:
```bash
ls manifests/advanced-cluster-management.v*.clusterserviceversion.yaml
```

### Required modifications to the CSV:

1. **Update CSV name** (line ~32) This name **must** be internally consistent when you create your catalog source:
```yaml
metadata:
  name: advanced-cluster-management.v2.15.0-custom  # Change to your custom version
```

2. **Update CSV version** (line ~42):
```yaml
spec:
  version: 2.15.0-custom-v1  # This is the version that will show up when you're selecting which version to install from the Web Console UI
```

3. **Update operator image reference** (line ~2527):
```yaml
- name: multiclusterhub-operator
  image: quay.io/YOUR_USERNAME/multiclusterhub-operator:2.15.0-custom  # Your custom image
```

4. **Update OPERATOR_VERSION environment variable** (line ~2524):
```yaml
- name: OPERATOR_VERSION
  value: 2.15.0-custom-v1  # Must match your image tag exactly
```

**⚠️ IMAGE-CODE SYNC CRITICAL**: The image reference and OPERATOR_VERSION MUST match the tag you built in Step 1. Mismatched versions are the #1 cause of "my changes don't work" issues.

5. **Update olm.skipRange annotation** (line ~31):
```yaml
annotations:
  olm.skipRange: '>=2.13.0 <2.15.0-custom-v1'  # Update upper bound to your latest version. OLM uses the bundle's metadata timestamps to determine the version ordering, so these *can* be named whatever you like
```

### Optional: Update display information:
```yaml
spec:
  displayName: "Custom ACM Catalog (Testing MCE Compliance)"  # Optional customization
```

## Build and Push Bundle

```bash
# Build bundle image
podman build -t quay.io/YOUR_USERNAME/acm-custom-bundle:2.15.0-custom-v1 .

# Push bundle image
podman push quay.io/YOUR_USERNAME/acm-custom-bundle:2.15.0-custom-v1
```

# Prepare Catalog Souce and Create Image

Since we're using the cloned bundle, we need to create our own catalog structure:

```bash
# Navigate to your custom catalog
cd /path/to/your/custom-catalog

# Create catalog structure
mkdir -p advanced-cluster-management
```

### Create catalog files:

#### `Dockerfile`:
```dockerfile
FROM quay.io/operator-framework/opm:latest

# Copy the file-based catalog
COPY advanced-cluster-management /configs/advanced-cluster-management

# Use the serve command to serve the FBC catalog  
ENTRYPOINT ["/bin/opm"]
CMD ["serve", "/configs", "--cache-dir=/tmp", "--cache-enforce-integrity=false"]
```

#### `advanced-cluster-management/bundles.yaml`:

**For single bundle:**
```yaml
---
schema: olm.bundle
name: advanced-cluster-management.v2.15.0-custom  # Must match CSV that you put into manifests/ name exactly. This is how OLM connects the catalog entry to the specific CSV inside the bundle image. This is necessary because Bundles can theoretically contain multiple CSVs, though this is rare
package: advanced-cluster-management
image: quay.io/YOUR_USERNAME/acm-custom-bundle:2.15.0-custom-v1 # direct the catalog entry to your bundle image
properties:
  - type: olm.gvk
    value:
      group: operator.open-cluster-management.io
      kind: MultiClusterHub
      version: v1
  - type: olm.package
    value:
      packageName: advanced-cluster-management
      version: 2.15.0-custom
```

**For multiple bundles (create additional bundles using Steps 1-5 with different versions):**
```yaml
---
schema: olm.bundle
name: advanced-cluster-management.v2.14.0-custom
package: advanced-cluster-management
image: quay.io/YOUR_USERNAME/acm-custom-bundle:2.14.0-custom-v1
properties:
  - type: olm.gvk
    value:
      group: operator.open-cluster-management.io
      kind: MultiClusterHub
      version: v1
  - type: olm.package
    value:
      packageName: advanced-cluster-management
      version: 2.14.0-custom
---
schema: olm.bundle
name: advanced-cluster-management.v2.15.0-custom
package: advanced-cluster-management
image: quay.io/YOUR_USERNAME/acm-custom-bundle:2.15.0-custom-v1
properties:
  - type: olm.gvk
    value:
      group: operator.open-cluster-management.io
      kind: MultiClusterHub
      version: v1
  - type: olm.package
    value:
      packageName: advanced-cluster-management
      version: 2.15.0-custom
```

#### `advanced-cluster-management/channel.yaml`:

**For single bundle:**
```yaml
---
schema: olm.channel
package: advanced-cluster-management
name: release-2.15
entries:
  - name: advanced-cluster-management.v2.15.0-custom
    replaces: advanced-cluster-management.v2.14.0 # if you're using a custom 2.14 image as well, you will need to match this name to the CSV metadata.name
```

**For multiple bundles:**
The `name` fields must match the `CSV` names (`metadata.name`) that are being created and replaced. These CSVs live inside the **bundle**.
```yaml
---
schema: olm.channel
package: advanced-cluster-management
name: release-2.15
entries:
  - name: advanced-cluster-management.v2.15.0-custom # Must match CSV metadata.name in 2.15 bundle
    replaces: advanced-cluster-management.v2.14.0 # Must match CSV metadata.name in 2.14 bundle
---
schema: olm.channel
package: advanced-cluster-management
name: release-2.14
entries:
  - name: advanced-cluster-management.v2.14.0 # Must match CSV metadata.name in 2.14 bundle
```

**For multiple bundles that each replace a different version (this is most common):**
The `name` fields must match the `CSV` names (`metadata.name`) that are being created and replaced. These CSVs live inside the **bundle**.
```yaml
---
schema: olm.channel
package: advanced-cluster-management
name: release-2.15
entries:
  - name: advanced-cluster-management.v2.14.0 # Must match CSV metadata.name in 2.14 bundle
  - name: advanced-cluster-management.v2.15.0-custom # Must match CSV metadata.name in 2.15 bundle
    replaces: advanced-cluster-management.v2.14.0 # Must match CSV metadata.name in 2.14 bundle
---
schema: olm.channel
package: advanced-cluster-management
name: release-2.14
entries:
  - name: advanced-cluster-management.v2.14.0 # Must match CSV metadata.name in 2.14 bundle
    replaces: advanced-cluster-management.v2.13.0 # Must match CSV metadata.name in 2.13 bundle
---
schema: olm.channel
package: advanced-cluster-management
name: release-2.13
entries:
  - name: advanced-cluster-management.v2.13.0 # Must match CSV metadata.name in 2.13 bundle
```

#### `advanced-cluster-management/package.yaml`:
```yaml
---
schema: olm.package
name: advanced-cluster-management
defaultChannel: release-2.15 # you can change this to whichever channel you prefer
```

## Build and Push Catalog

```bash
podman build -t quay.io/YOUR_USERNAME/acm-custom-catalog:v0.0.1 .
podman push quay.io/YOUR_USERNAME/acm-custom-catalog:v0.0.1
```

# Deploy to Cluster

### Create catalog source:
```yaml
apiVersion: operators.coreos.com/v1alpha1
kind: CatalogSource
metadata:
  name: acm-custom-catalog
  namespace: openshift-marketplace
spec:
  sourceType: grpc
  image: quay.io/YOUR_USERNAME/acm-custom-catalog:v0.0.1
  displayName: "Custom ACM Catalog"
  publisher: "Your Name"
  secrets:
  - multiclusterhub-operator-pull-secret
  updateStrategy:
    registryPoll:
      interval: 10m
```

# Install ACM:

**Important**: You can at this point just install ACM via the web console as a normal user would (recommended), however, if you prefer to use the CLI, these steps may help

```bash
# Create namespace and operator group
kubectl create namespace open-cluster-management

kubectl apply -f - << EOF
apiVersion: operators.coreos.com/v1
kind: OperatorGroup
metadata:
  name: open-cluster-management
  namespace: open-cluster-management
spec:
  targetNamespaces:
  - open-cluster-management
EOF

# Create subscription
kubectl apply -f - << EOF
apiVersion: operators.coreos.com/v1alpha1
kind: Subscription
metadata:
  name: advanced-cluster-management
  namespace: open-cluster-management
spec:
  channel: release-2.15
  name: advanced-cluster-management
  source: acm-custom-catalog
  sourceNamespace: openshift-marketplace
  installPlanApproval: Automatic
  startingCSV: advanced-cluster-management.v2.15.0-custom
EOF
```

## Step 9: Verify Your Changes Work

Test that your specific changes are working as expected.


# Common FYIs, issues, and pitfalls
## Critical Naming Consistency

**These names must match exactly:**
- CSV `metadata.name`: `advanced-cluster-management.v2.15.0-custom`
- Bundle `name` in bundles.yaml: `advanced-cluster-management.v2.15.0-custom`
- Channel `entries.name`: `advanced-cluster-management.v2.15.0-custom`
- Subscription `startingCSV`: `advanced-cluster-management.v2.15.0-custom`

## Advantages of Using Cloned Repository

1. **Pre-configured structure**: No need to create bundle directory structure
2. **Complete CRDs**: All necessary CRDs already included and up-to-date
3. **Proper annotations**: Bundle metadata already correctly configured
4. **Working Dockerfile**: Bundle build process already set up
5. **Minimal changes required**: Only need to update 4-5 lines in the CSV

## Iterative Development Workflow

For each code change iteration:

1. **Make code changes** in multiclusterhub-operator
2. **Build operator image** with incremented tag (`v2`, `v3`, etc.)
3. **Update CSV** with new image reference and OPERATOR_VERSION
4. **Rebuild bundle** with matching tag
5. **Update bundles.yaml** to point to new bundle
6. **Rebuild catalog** with incremented version
7. **Update catalog source** in cluster
8. **Test changes** work as expected

**Version Strategy:**
- Operator image tag: `2.15.0-custom-v1`, `v2`, `v3` (increment for each code change)
- CSV version: `2.15.0-custom` (stays constant for same feature branch)  
- Bundle tag: Match operator image tag
- Catalog tag: `v1.0.0`, `v1.0.1`, etc.

## Common Pitfalls and How to Avoid Them

1. **Image-Code Mismatch**: Building CSV with image tag that doesn't contain your code changes
   - **Solution**: Always rebuild operator image after code changes, use incremental tags

2. **OPERATOR_VERSION Mismatch**: Environment variable doesn't match image tag
   - **Solution**: Always update both image reference AND OPERATOR_VERSION in CSV

3. **Subscription Recovery**: Stuck subscriptions after bundle updates
   - **Solution**: Delete and recreate subscription to pick up new install plan

4. **CSV Name Inconsistency**: Mismatched names between CSV, bundle, channel, and subscription
   - **Solution**: Use exact same name across all references

## Success Verification

Your bundle is working correctly when:
- CSV shows "Succeeded" phase
- MCH operator pods are running and healthy  
- Your specific code changes are executing as expected
- No reconciliation errors in operator logs

This workflow ensures code changes are properly packaged and deployed through the complete bundle → catalog → operator pipeline.