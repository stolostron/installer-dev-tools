# Vulnerability Scanner - Quick Start Guide

## TL;DR

```bash
# Basic scan (CRITICAL and HIGH vulnerabilities)
./scan-cluster-vulnerabilities.sh

# Scan specific namespace
./scan-cluster-vulnerabilities.sh --namespace openshift-gitops

# Detailed scan with per-image reports
./scan-cluster-vulnerabilities.sh --detailed
```

## Common Commands

```bash
# Scan all namespaces for CRITICAL/HIGH vulnerabilities
./scan-cluster-vulnerabilities.sh

# Scan specific namespace with all severity levels
./scan-cluster-vulnerabilities.sh -n production -s CRITICAL,HIGH,MEDIUM,LOW

# Generate JSON report for automation
./scan-cluster-vulnerabilities.sh -f json

# Scan only ACM images
./scan-cluster-vulnerabilities.sh -i "acm-d"

# Include unfixed vulnerabilities
./scan-cluster-vulnerabilities.sh -u

# Fast scan (shorter timeout)
./scan-cluster-vulnerabilities.sh -t 120
```

## Output Files

All reports are saved to `./vulnerability-reports/`:

- `vulnerability-summary-TIMESTAMP.txt` - Human-readable summary
- `vulnerability-summary-TIMESTAMP.json` - Machine-readable summary
- `detailed-vulnerabilities-TIMESTAMP.csv` - **CVE details with CVSS scores** ⭐
- `IMAGE-NAME-TIMESTAMP.FORMAT` - Per-image reports (with --detailed)

### NEW! CVE Details CSV

The CSV file contains actionable vulnerability data:
- Image name
- CVE ID (e.g., CVE-2024-1234)
- Severity (CRITICAL, HIGH, etc.)
- **CVSS Score** (numerical risk score)
- Package name
- Installed version
- **Fixed version** (what to upgrade to)
- Vulnerability description

**Use this file to:**
- Identify which images to rebuild
- Prioritize fixes by CVSS score
- Track unfixable vulnerabilities
- Generate compliance reports

## Interpreting Results

### Summary Report

```
Total Images Scanned: 47
  - With Vulnerabilities: 23  ← Images with CVEs
  - Clean: 22                 ← No vulnerabilities found
  - Failed: 2                 ← Scan errors

Total Vulnerabilities Found:
  - CRITICAL: 15              ← Fix immediately
  - HIGH: 42                  ← Fix soon
  - MEDIUM: 0
  - LOW: 0
```

### Exit Codes

- **0** = Clean (no CRITICAL/HIGH vulnerabilities)
- **1** = Vulnerabilities found or scan failed

## Quick Fixes

### If scan fails to connect to cluster:
```bash
oc login https://your-cluster-url:6443
```

### If Trivy not found:
```bash
# It will auto-install, but if that fails:
curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b $HOME/.local/bin
export PATH="$HOME/.local/bin:$PATH"
```

### If jq not found:
```bash
# macOS
brew install jq

# RHEL/Fedora
sudo dnf install jq
```

### If scan is too slow:
```bash
# Use namespace filtering
./scan-cluster-vulnerabilities.sh -n specific-namespace

# Or increase parallelism
./scan-cluster-vulnerabilities.sh -p 10
```

## What to Do with Results

1. **CRITICAL vulnerabilities** → Fix immediately, rebuild images
2. **HIGH vulnerabilities** → Schedule fix in next sprint
3. **MEDIUM/LOW** → Track and fix during regular maintenance
4. **No fix available** → Document risk acceptance or find alternatives

## Quick Analysis of CVE Report

```bash
# Open CSV in Excel/Google Sheets
open vulnerability-reports/detailed-vulnerabilities-*.csv

# Find all CRITICAL CVEs
grep "CRITICAL" vulnerability-reports/detailed-vulnerabilities-*.csv

# Find vulnerabilities in specific package
grep -i "openssl" vulnerability-reports/detailed-vulnerabilities-*.csv

# Count CVEs by severity
cut -d',' -f3 vulnerability-reports/detailed-vulnerabilities-*.csv | sort | uniq -c

# Find unfixable vulnerabilities
grep "No fix available" vulnerability-reports/detailed-vulnerabilities-*.csv

# Find images with most CVEs
cut -d',' -f1 vulnerability-reports/detailed-vulnerabilities-*.csv | sort | uniq -c | sort -rn
```

## Integration with CI/CD

### Block deployment if vulnerabilities found:

```bash
#!/bin/bash
if ! ./scan-cluster-vulnerabilities.sh -n production -s CRITICAL,HIGH; then
  echo "Deployment blocked due to vulnerabilities"
  exit 1
fi
```

### Daily scheduled scan:

```bash
# Add to crontab
0 2 * * * /path/to/scan-cluster-vulnerabilities.sh >> /var/log/vuln-scan.log 2>&1
```

## Need More Help?

See `README-vulnerability-scanner.md` for:
- Detailed options explanation
- Advanced use cases
- Troubleshooting guide
- Integration examples
- Performance tuning
