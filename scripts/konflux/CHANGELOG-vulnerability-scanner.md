# Vulnerability Scanner - Changelog

## Version 1.1 - 2025-10-31

### Bug Fixes
- **Fixed critical bug**: Increment operators (`((VAR++))`) with `set -euo pipefail` were causing script to exit prematurely when variables started at 0
  - Changed `((CLEAN++))` to `CLEAN=$((CLEAN + 1))`
  - Changed `((SCANNED++))` to `SCANNED=$((SCANNED + 1))`
  - Changed `((FAILED++))` to `FAILED=$((FAILED + 1))`
  - Changed `((counter++))` to `counter=$((counter + 1))`

### New Features
- **Detailed CVE Report (CSV)**: New CSV file with comprehensive vulnerability details
  - File: `detailed-vulnerabilities-TIMESTAMP.csv`
  - Columns:
    - Image - Full image reference
    - CVE ID - CVE identifier (e.g., CVE-2024-1234)
    - Severity - CRITICAL, HIGH, MEDIUM, LOW, UNKNOWN
    - CVSS Score - Numerical score from NVD or Red Hat
    - Package Name - Affected package
    - Installed Version - Current version in image
    - Fixed Version - Version that fixes the vulnerability (or "No fix available")
    - Title - Human-readable vulnerability description

- **Top Critical CVEs in Summary**: Summary report now includes top 10 CRITICAL vulnerabilities with key details

- **CVE Count in Output**: Terminal output now shows total number of documented CVEs

### Enhanced Output

#### New CSV Format
```csv
Image,CVE ID,Severity,CVSS Score,Package Name,Installed Version,Fixed Version,Title
"quay.io/acm-d/console@sha256:abc","CVE-2024-1234","CRITICAL",9.8,"openssl","1.1.1k","1.1.1l","Remote code execution"
```

#### Updated Summary Report
```
TOP CRITICAL VULNERABILITIES (Sample)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

CVE-2024-1234 (CVSS: 9.8)
  Image: quay.io/acm-d/console@sha256:abc
  Package: openssl
  Fixed Version: 1.1.1l

...

For complete CVE details, see: vulnerability-reports/detailed-vulnerabilities-TIMESTAMP.csv

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

SUMMARY
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Total Images Scanned: 47
  - With Vulnerabilities: 23
  - Clean: 22
  - Failed: 2

Total Vulnerabilities Found:
  - CRITICAL: 15
  - HIGH: 42

Detailed CVE Report: vulnerability-reports/detailed-vulnerabilities-TIMESTAMP.csv
```

#### Updated Terminal Output
```
Reports saved to:
  Summary Report:
    vulnerability-reports/vulnerability-summary-20251031-143022.txt
  JSON Summary:
    vulnerability-reports/vulnerability-summary-20251031-143022.json
  CVE Details (CSV):
    vulnerability-reports/detailed-vulnerabilities-20251031-143022.csv

Total CVEs documented: 127
View detailed CVE report: vulnerability-reports/detailed-vulnerabilities-20251031-143022.csv
```

## Version 1.0 - 2025-10-31

### Initial Release
- Cluster-wide vulnerability scanning
- Namespace filtering
- Multiple output formats (table, JSON, SARIF, SPDX, CycloneDX)
- Severity filtering
- Auto-installation of Trivy
- Offline mode support
- Parallel scanning
- Summary reports

## Usage Examples with New Features

### Example 1: Generate CVE Report for Security Review
```bash
./scan-cluster-vulnerabilities.sh \
  --namespace production \
  --severity CRITICAL,HIGH \
  --detailed

# Open the CSV in Excel/Google Sheets for analysis
open vulnerability-reports/detailed-vulnerabilities-*.csv
```

### Example 2: Filter Critical CVEs for Specific Package
```bash
# Run scan
./scan-cluster-vulnerabilities.sh

# Filter CVEs for openssl
grep -i openssl vulnerability-reports/detailed-vulnerabilities-*.csv
```

### Example 3: Extract CVEs by CVSS Score
```bash
# Find all CVEs with CVSS >= 9.0
awk -F',' '$4 >= 9.0 {print}' vulnerability-reports/detailed-vulnerabilities-*.csv
```

### Example 4: Group CVEs by Image
```bash
# Sort by image to see all CVEs per image
sort -t',' -k1 vulnerability-reports/detailed-vulnerabilities-*.csv > cves-by-image.csv
```

### Example 5: Find Unfixable Vulnerabilities
```bash
# Find CVEs with no fix available
grep "No fix available" vulnerability-reports/detailed-vulnerabilities-*.csv
```

## CSV Processing Tips

### Import into Spreadsheet
1. Open Excel/Google Sheets/LibreOffice
2. Import the CSV file
3. Use delimiter: comma
4. Enable filtering and sorting
5. Create pivot tables for analysis

### Command-Line Analysis
```bash
# Count CVEs by severity
cut -d',' -f3 detailed-vulnerabilities-*.csv | sort | uniq -c

# List unique affected packages
cut -d',' -f5 detailed-vulnerabilities-*.csv | sort -u

# Find images with most CVEs
cut -d',' -f1 detailed-vulnerabilities-*.csv | sort | uniq -c | sort -rn

# Extract only CRITICAL CVEs
awk -F',' '$3 == "\"CRITICAL\"" {print}' detailed-vulnerabilities-*.csv
```

### Database Import
```sql
-- PostgreSQL example
CREATE TABLE vulnerabilities (
    image TEXT,
    cve_id TEXT,
    severity TEXT,
    cvss_score NUMERIC,
    package_name TEXT,
    installed_version TEXT,
    fixed_version TEXT,
    title TEXT
);

\COPY vulnerabilities FROM 'detailed-vulnerabilities-20251031-143022.csv' WITH CSV HEADER;

-- Query high-risk images
SELECT image, COUNT(*) as critical_count
FROM vulnerabilities
WHERE severity = 'CRITICAL'
GROUP BY image
ORDER BY critical_count DESC;
```

## Migration from v1.0 to v1.1

No breaking changes. The script is backward compatible. New CSV file is automatically generated on each run.

## Known Issues

None currently identified.

## Future Enhancements

- HTML report generation
- Email notifications for critical CVEs
- Integration with ticketing systems (Jira, GitHub Issues)
- Historical trend analysis
- CVE age tracking
- Fix availability timeline
